#!/bin/bash
PACK="$HOME/.vim/pack/git-plugins/start/"
PACK_LIST="$HOME/.vim/plugins"
GIT=$(which git)

install ()
{
    # Check if urls file exists.
    [ -f "$PACK_LIST" ] || return 0

    # Install all listed plugins.
    cd $PACK
    for url in $(cat "$PACK_LIST"); do
        CLONE_DIR=$(echo "$url" | sed -e 's/^.*\///' -e 's/\.git//')
        [ -d $CLONE_DIR ] && continue

        echo "Cloning $url into $CLONE_DIR"
        $GIT clone "$url"
    done
}

update ()
{
    # Update all installed plugins.
    cd $PACK
    for dir in *; do
        PLUGIN="$PACK$dir"
        [ -d "$PLUGIN/.git" ] || continue

        echo "Updating $dir"
        cd $PLUGIN
        $GIT stash; $GIT pull; $GIT stash pop;
        echo ""
    done
}

save()
{
    # Clear current bundle list file.
    if [ -f "$PACK_LIST" ]
    then
        >| "$PACK_LIST"
    fi

    # Update file with git repo urls.
    cd $PACK
    for dir in *; do
        PLUGIN="$PACK$dir"
        cd $PLUGIN

        if [ -d "$PLUGIN/.git" ]
        then
            echo `$GIT url` >> "$PACK_LIST"
        fi
    done
}

main ()
{
    [ "$GIT" ] || return 0;

    [ -d $PACK ] || mkdir -p $PACK

    case "$1" in
        "") echo "Usage: ${0##*/} install|update|save"; exit;;
        "install") install; exit;;
        "update") update; exit;;
        "save") save; exit;;
    esac
}

main $@

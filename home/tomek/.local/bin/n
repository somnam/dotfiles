#!/bin/bash
set -e

filepath() {
    local realpath=$(which realpath);
    { [[ -x $realpath ]] && echo $($realpath $1); } || { echo $(cd $(dirname $1); pwd)/$(basename $1); }
}

nvim() {
    local nvim=$(which nvim);
    { [[ -x $nvim ]] && echo $nvim; } || { echo "Neovim not installed"; exit 1; }
}

cache() {
    local cache="$HOME/.cache/nvim";
    $(which mkdir) -p "$cache";
    echo $cache;
}

pipe() {
    echo "$(cache)/server.pipe";
}

open_remote() {
    [[ $# -ne 0 ]] && $(nvim) --server $(pipe) --remote $@;
}

run_serer() {
    $(nvim) --listen $(pipe) $@;
}

main () {
    local filepaths=();
    for file in "$@"; do
        filepaths+=($(filepath $file));
    done

    if [[ -S $(pipe) ]]; then
        open_remote "${filepaths[@]}";
    else
        run_serer "${filepaths[@]}";
    fi
}

main $@
